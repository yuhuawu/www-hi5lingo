---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';
import { languages } from '../../../i18n/ui';
import { useTranslations } from '../../../i18n/utils';

// 1. Generate static paths for all characters AND all languages
export async function getStaticPaths() {
  const { data: characters, error } = await supabase
    .from('characters')
    .select('char');

  if (error || !characters) {
    console.error('Error fetching characters for paths:', error);
    return [];
  }

  const locales = Object.keys(languages);
  
  // Generate a route for every character in every language
  return characters.flatMap((c) => 
    locales.map((lang) => ({
      params: { lang, char: c.char },
    }))
  );
}

const { lang, char } = Astro.params;
const t = useTranslations(lang as any);

if (!char) {
  return Astro.redirect('/404');
}

// Fetch character details
const { data: characterData, error: charError } = await supabase
  .from('characters')
  .select('*')
  .eq('char', char)
  .single();

if (charError || !characterData) {
  console.error(`Error fetching character data for ${char}:`, charError);
  return Astro.redirect('/404');
}

// Fetch example sentences
const { data: sentences, error: sentenceError } = await supabase
  .from('sentences')
  .select('*')
  .eq('char_id', characterData.id);

if (sentenceError) {
  console.error(`Error fetching sentences for ${char}:`, sentenceError);
}

// --- DEBUGGING LOGS (Server Side) ---
console.log(`[Server] Rendering character: ${characterData.char}`);
console.log(`[Server] Stroke Data Type: ${typeof characterData.stroke_data}`);
console.log(`[Server] Stroke Data Content:`, JSON.stringify(characterData.stroke_data).substring(0, 100) + '...');
// ------------------------------------

// TODO: Localize these strings based on `lang`
const title = `Learn Chinese Character ${characterData.char} (${characterData.pinyin}) | Hi5Lingo`;
const description = `Master the Chinese character ${characterData.char} (${characterData.pinyin}). Definition: ${characterData.definition}. Includes stroke order, HSK level, and example sentences.`;

const strokeData = characterData.stroke_data;
const charString = characterData.char;
---

<Layout title={title} description={description} lang={lang as any}>
  <!-- Load HanziWriter from CDN -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

  <div class="container mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="flex text-sm text-slate-500 mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li><a href={`/${lang === 'en' ? '' : lang}`} class="hover:text-indigo-600">{t('footer.home')}</a></li>
        <li><span class="mx-2">/</span></li>
        <li class="text-slate-900 font-semibold">{characterData.char}</li>
      </ol>
    </nav>

    <div class="grid md:grid-cols-3 gap-12">
      <!-- Left Column: Character Card -->
      <div class="md:col-span-1">
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 sticky top-24">
          <div class="bg-indigo-600 p-8 text-center text-white">
            <h1 class="text-9xl font-bold mb-4">{characterData.char}</h1>
            <p class="text-3xl font-mono opacity-90">{characterData.pinyin}</p>
          </div>
          <div class="p-8 space-y-6">
            <div>
              <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Definition</h3>
              <p class="text-xl font-medium text-slate-900">{characterData.definition}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-slate-50 p-4 rounded-xl">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">HSK Level</h3>
                <p class="text-2xl font-bold text-indigo-600">{characterData.hsk_level}</p>
              </div>
              <div class="bg-slate-50 p-4 rounded-xl">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Strokes</h3>
                <p class="text-2xl font-bold text-indigo-600">{characterData.stroke_count}</p>
              </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
               <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Stroke Order</h3>
               
               <!-- Explicitly set height/width on container to ensure visibility -->
               <div class="aspect-square bg-slate-50 rounded-xl flex items-center justify-center p-4 relative">
                  {!strokeData && (
                    <div class="text-red-500 text-sm font-bold absolute z-10 text-center px-4">
                        Data Missing in DB.<br/>Please run the SQL Update.
                    </div>
                  )}
                  <div id="character-target-div" style="width: 200px; height: 200px;"></div>
               </div>
               <p class="text-xs text-center text-slate-400 mt-2">Animated Stroke Order</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Details & Sentences -->
      <div class="md:col-span-2 space-y-12">
        
        {/* Intro Text */}
        <section>
          <h2 class="text-3xl font-bold text-slate-900 mb-6">About "{characterData.char}"</h2>
          <p class="text-lg text-slate-600 leading-relaxed">
            The Chinese character <strong>{characterData.char}</strong> (pinyin: <em>{characterData.pinyin}</em>) means "{characterData.definition}". 
            It is an HSK Level {characterData.hsk_level} character, making it essential for {characterData.hsk_level <= 3 ? 'beginners' : 'intermediate learners'}.
          </p>
        </section>

        {/* Example Sentences */}
        {sentences && sentences.length > 0 && (
          <section>
            <h2 class="text-3xl font-bold text-slate-900 mb-8 flex items-center">
              <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
              </span>
              Example Sentences
            </h2>
            <div class="space-y-6">
              {sentences.map((sentence) => (
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
                  <p class="text-2xl font-medium text-slate-900 mb-2">{sentence.chinese}</p>
                  <p class="text-slate-500 font-mono mb-3">{sentence.pinyin}</p>
                  <p class="text-lg text-indigo-900 border-l-4 border-indigo-200 pl-3">{sentence.english}</p>
                  {sentence.audio_url && (
                    <audio controls src={sentence.audio_url} class="mt-4 w-full h-8">
                      Your browser does not support the audio element.
                    </audio>
                  )}
                </div>
              ))}
            </div>
          </section>
        )}

        {/* Call to Action */}
        <section class="bg-indigo-50 p-8 rounded-3xl text-center">
          <h3 class="text-2xl font-bold text-indigo-900 mb-4">Want to learn more characters like {characterData.char}?</h3>
          <p class="text-indigo-700 mb-8">Join Hi5Lingo today and access our full curriculum.</p>
          <a href="/" class="inline-block px-8 py-3 bg-indigo-600 text-white font-bold rounded-full hover:bg-indigo-700 transition">Start Learning Free</a>
        </section>

      </div>
    </div>
  </div>

  <script define:vars={{ strokeData, charString }}>
    if (strokeData && document.getElementById('character-target-div')) {
        const checkHanziWriter = setInterval(() => {
            if (typeof HanziWriter !== 'undefined') {
                clearInterval(checkHanziWriter);
                
                try {
                    // Normalize strokeData if it is a string
                    let parsedData = strokeData;
                    if (typeof strokeData === 'string') {
                         parsedData = JSON.parse(strokeData);
                    }

                    const writer = HanziWriter.create('character-target-div', charString, {
                        width: 200,
                        height: 200,
                        padding: 5,
                        showOutline: true,
                        charDataLoader: (char, onComplete) => {
                          onComplete(parsedData);
                        }
                    });
                    
                    writer.loopCharacterAnimation();
                } catch (e) {
                    console.error('HanziWriter error:', e);
                }
            }
        }, 100);
    }
  </script>
</Layout>
